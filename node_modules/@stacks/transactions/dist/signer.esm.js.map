{"version":3,"file":"signer.esm.js","sources":["../src/signer.ts"],"sourcesContent":["import { StacksTransaction } from './transaction';\n\nimport { StacksPrivateKey, StacksPublicKey } from './keys';\nimport { isSingleSig } from './authorization';\nimport { cloneDeep } from './utils';\nimport { SpendingCondition } from './authorization';\nimport { AuthType } from './constants';\nimport { SigningError } from './errors';\n\nexport class TransactionSigner {\n  transaction: StacksTransaction;\n  sigHash: string;\n  originDone: boolean;\n  checkOversign: boolean;\n  checkOverlap: boolean;\n\n  constructor(transaction: StacksTransaction) {\n    this.transaction = transaction;\n    this.sigHash = transaction.signBegin();\n    this.originDone = false;\n    this.checkOversign = true;\n    this.checkOverlap = true;\n  }\n\n  static createSponsorSigner(transaction: StacksTransaction, spendingCondition: SpendingCondition) {\n    if (transaction.auth.authType != AuthType.Sponsored) {\n      throw new SigningError('Cannot add sponsor to non-sponsored transaction');\n    }\n\n    const tx: StacksTransaction = cloneDeep(transaction);\n    tx.setSponsor(spendingCondition);\n    const originSigHash = tx.verifyOrigin();\n    const signer = new this(tx);\n    signer.originDone = true;\n    signer.sigHash = originSigHash;\n    signer.checkOversign = true;\n    signer.checkOverlap = true;\n    return signer;\n  }\n\n  signOrigin(privateKey: StacksPrivateKey) {\n    if (this.checkOverlap && this.originDone) {\n      throw new SigningError('Cannot sign origin after sponsor key');\n    }\n\n    if (this.transaction.auth === undefined) {\n      throw new SigningError('\"transaction.auth\" is undefined');\n    }\n    if (this.transaction.auth.spendingCondition === undefined) {\n      throw new SigningError('\"transaction.auth.spendingCondition\" is undefined');\n    }\n\n    if (!isSingleSig(this.transaction.auth.spendingCondition)) {\n      const spendingCondition = this.transaction.auth.spendingCondition;\n      if (\n        this.checkOversign &&\n        spendingCondition.fields.length >= spendingCondition.signaturesRequired\n      ) {\n        throw new Error('Origin would have too many signatures');\n      }\n    }\n\n    const nextSighash = this.transaction.signNextOrigin(this.sigHash, privateKey);\n    this.sigHash = nextSighash;\n  }\n\n  appendOrigin(publicKey: StacksPublicKey) {\n    if (this.checkOverlap && this.originDone) {\n      throw Error('Cannot append public key to origin after sponsor key');\n    }\n\n    if (this.transaction.auth === undefined) {\n      throw new Error('\"transaction.auth\" is undefined');\n    }\n    if (this.transaction.auth.spendingCondition === undefined) {\n      throw new Error('\"transaction.auth.spendingCondition\" is undefined');\n    }\n\n    this.transaction.appendPubkey(publicKey);\n  }\n\n  signSponsor(privateKey: StacksPrivateKey) {\n    if (this.transaction.auth === undefined) {\n      throw new SigningError('\"transaction.auth\" is undefined');\n    }\n    if (this.transaction.auth.sponsorSpendingCondition === undefined) {\n      throw new SigningError('\"transaction.auth.spendingCondition\" is undefined');\n    }\n\n    const nextSighash = this.transaction.signNextSponsor(this.sigHash, privateKey);\n    this.sigHash = nextSighash;\n    this.originDone = true;\n  }\n\n  getTxInComplete(): StacksTransaction {\n    return cloneDeep(this.transaction);\n  }\n\n  resume(transaction: StacksTransaction) {\n    this.transaction = cloneDeep(transaction);\n    this.sigHash = transaction.signBegin();\n  }\n}\n"],"names":["TransactionSigner","transaction","sigHash","signBegin","originDone","checkOversign","checkOverlap","createSponsorSigner","spendingCondition","auth","authType","AuthType","Sponsored","SigningError","tx","cloneDeep","setSponsor","originSigHash","verifyOrigin","signer","signOrigin","privateKey","undefined","isSingleSig","fields","length","signaturesRequired","Error","nextSighash","signNextOrigin","appendOrigin","publicKey","appendPubkey","signSponsor","sponsorSpendingCondition","signNextSponsor","getTxInComplete","resume"],"mappings":";;;;;IASaA,iBAAb;AAOE,6BAAYC,WAAZ;AACE,SAAKA,WAAL,GAAmBA,WAAnB;AACA,SAAKC,OAAL,GAAeD,WAAW,CAACE,SAAZ,EAAf;AACA,SAAKC,UAAL,GAAkB,KAAlB;AACA,SAAKC,aAAL,GAAqB,IAArB;AACA,SAAKC,YAAL,GAAoB,IAApB;AACD;;AAbH,oBAeSC,mBAfT,GAeE,6BAA2BN,WAA3B,EAA2DO,iBAA3D;AACE,QAAIP,WAAW,CAACQ,IAAZ,CAAiBC,QAAjB,IAA6BC,QAAQ,CAACC,SAA1C,EAAqD;AACnD,YAAM,IAAIC,YAAJ,CAAiB,iDAAjB,CAAN;AACD;;AAED,QAAMC,EAAE,GAAsBC,SAAS,CAACd,WAAD,CAAvC;AACAa,IAAAA,EAAE,CAACE,UAAH,CAAcR,iBAAd;AACA,QAAMS,aAAa,GAAGH,EAAE,CAACI,YAAH,EAAtB;AACA,QAAMC,MAAM,GAAG,IAAI,IAAJ,CAASL,EAAT,CAAf;AACAK,IAAAA,MAAM,CAACf,UAAP,GAAoB,IAApB;AACAe,IAAAA,MAAM,CAACjB,OAAP,GAAiBe,aAAjB;AACAE,IAAAA,MAAM,CAACd,aAAP,GAAuB,IAAvB;AACAc,IAAAA,MAAM,CAACb,YAAP,GAAsB,IAAtB;AACA,WAAOa,MAAP;AACD,GA7BH;;AAAA;;AAAA,SA+BEC,UA/BF,GA+BE,oBAAWC,UAAX;AACE,QAAI,KAAKf,YAAL,IAAqB,KAAKF,UAA9B,EAA0C;AACxC,YAAM,IAAIS,YAAJ,CAAiB,sCAAjB,CAAN;AACD;;AAED,QAAI,KAAKZ,WAAL,CAAiBQ,IAAjB,KAA0Ba,SAA9B,EAAyC;AACvC,YAAM,IAAIT,YAAJ,CAAiB,iCAAjB,CAAN;AACD;;AACD,QAAI,KAAKZ,WAAL,CAAiBQ,IAAjB,CAAsBD,iBAAtB,KAA4Cc,SAAhD,EAA2D;AACzD,YAAM,IAAIT,YAAJ,CAAiB,mDAAjB,CAAN;AACD;;AAED,QAAI,CAACU,WAAW,CAAC,KAAKtB,WAAL,CAAiBQ,IAAjB,CAAsBD,iBAAvB,CAAhB,EAA2D;AACzD,UAAMA,iBAAiB,GAAG,KAAKP,WAAL,CAAiBQ,IAAjB,CAAsBD,iBAAhD;;AACA,UACE,KAAKH,aAAL,IACAG,iBAAiB,CAACgB,MAAlB,CAAyBC,MAAzB,IAAmCjB,iBAAiB,CAACkB,kBAFvD,EAGE;AACA,cAAM,IAAIC,KAAJ,CAAU,uCAAV,CAAN;AACD;AACF;;AAED,QAAMC,WAAW,GAAG,KAAK3B,WAAL,CAAiB4B,cAAjB,CAAgC,KAAK3B,OAArC,EAA8CmB,UAA9C,CAApB;AACA,SAAKnB,OAAL,GAAe0B,WAAf;AACD,GAvDH;;AAAA,SAyDEE,YAzDF,GAyDE,sBAAaC,SAAb;AACE,QAAI,KAAKzB,YAAL,IAAqB,KAAKF,UAA9B,EAA0C;AACxC,YAAMuB,KAAK,CAAC,sDAAD,CAAX;AACD;;AAED,QAAI,KAAK1B,WAAL,CAAiBQ,IAAjB,KAA0Ba,SAA9B,EAAyC;AACvC,YAAM,IAAIK,KAAJ,CAAU,iCAAV,CAAN;AACD;;AACD,QAAI,KAAK1B,WAAL,CAAiBQ,IAAjB,CAAsBD,iBAAtB,KAA4Cc,SAAhD,EAA2D;AACzD,YAAM,IAAIK,KAAJ,CAAU,mDAAV,CAAN;AACD;;AAED,SAAK1B,WAAL,CAAiB+B,YAAjB,CAA8BD,SAA9B;AACD,GAtEH;;AAAA,SAwEEE,WAxEF,GAwEE,qBAAYZ,UAAZ;AACE,QAAI,KAAKpB,WAAL,CAAiBQ,IAAjB,KAA0Ba,SAA9B,EAAyC;AACvC,YAAM,IAAIT,YAAJ,CAAiB,iCAAjB,CAAN;AACD;;AACD,QAAI,KAAKZ,WAAL,CAAiBQ,IAAjB,CAAsByB,wBAAtB,KAAmDZ,SAAvD,EAAkE;AAChE,YAAM,IAAIT,YAAJ,CAAiB,mDAAjB,CAAN;AACD;;AAED,QAAMe,WAAW,GAAG,KAAK3B,WAAL,CAAiBkC,eAAjB,CAAiC,KAAKjC,OAAtC,EAA+CmB,UAA/C,CAApB;AACA,SAAKnB,OAAL,GAAe0B,WAAf;AACA,SAAKxB,UAAL,GAAkB,IAAlB;AACD,GAnFH;;AAAA,SAqFEgC,eArFF,GAqFE;AACE,WAAOrB,SAAS,CAAC,KAAKd,WAAN,CAAhB;AACD,GAvFH;;AAAA,SAyFEoC,MAzFF,GAyFE,gBAAOpC,WAAP;AACE,SAAKA,WAAL,GAAmBc,SAAS,CAACd,WAAD,CAA5B;AACA,SAAKC,OAAL,GAAeD,WAAW,CAACE,SAAZ,EAAf;AACD,GA5FH;;AAAA;AAAA;;;;"}